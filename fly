local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer

if player.PlayerGui:FindFirstChild("FlightCapsule") then
    player.PlayerGui.FlightCapsule:Destroy()
end

local flying = false
local speed = 100
local keys = {W=false,S=false,A=false,D=false,Space=false,LShift=false}
local bv, bg

local sg = Instance.new("ScreenGui", player.PlayerGui)
sg.Name = "FlightCapsule"

local capsule = Instance.new("Frame", sg)
capsule.Size = UDim2.new(0, 240, 0, 60)
capsule.Position = UDim2.new(0.15, 0, 0.4, 0)
capsule.BackgroundColor3 = Color3.fromRGB(10, 15, 20)
capsule.BackgroundTransparency = 0.1
capsule.BorderSizePixel = 0
Instance.new("UICorner", capsule).CornerRadius = UDim.new(1, 0)

local stroke = Instance.new("UIStroke", capsule)
stroke.Color = Color3.fromRGB(100, 200, 255)
stroke.Transparency = 0.7
stroke.Thickness = 2

local dragging, dragInput, dragStart, startPos

local function update(input)
    local delta = input.Position - dragStart
    capsule.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
                                 startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

capsule.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = capsule.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

capsule.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UIS.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

local flyBtn = Instance.new("TextButton", capsule)
flyBtn.Size = UDim2.new(0, 48, 0, 48)
flyBtn.Position = UDim2.new(0, 6, 0.5, -24)
flyBtn.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
flyBtn.Text = "H"
flyBtn.Font = Enum.Font.GothamBold
flyBtn.TextColor3 = Color3.new(1,1,1)
flyBtn.TextSize = 18
Instance.new("UICorner", flyBtn).CornerRadius = UDim.new(1, 0)

local speedBox = Instance.new("TextBox", capsule)
speedBox.Size = UDim2.new(0, 100, 0, 40)
speedBox.Position = UDim2.new(0, 125, 0.5, -20)
speedBox.BackgroundTransparency = 1
speedBox.Text = tostring(speed)
speedBox.TextColor3 = Color3.fromRGB(150, 230, 255)
speedBox.Font = Enum.Font.GothamBold
speedBox.TextSize = 24
speedBox.TextXAlignment = Enum.TextXAlignment.Center

local label = Instance.new("TextLabel", capsule)
label.Size = UDim2.new(0, 70, 0, 20)
label.Position = UDim2.new(0, 65, 0.5, -10)
label.Text = "SPEED"
label.TextColor3 = Color3.fromRGB(100,150,180)
label.Font = Enum.Font.Gotham
label.TextSize = 12
label.BackgroundTransparency = 1
label.TextXAlignment = Enum.TextXAlignment.Left

local COLOR_OFF = Color3.fromRGB(50, 80, 120)
local COLOR_ON = Color3.fromRGB(100, 200, 255)
local COLOR_HOVER = Color3.fromRGB(150, 230, 255)
local COLOR_CLICK = Color3.fromRGB(80, 180, 220)

flyBtn.MouseEnter:Connect(function()
    if flying then return end
    flyBtn.BackgroundColor3 = COLOR_HOVER
end)
flyBtn.MouseLeave:Connect(function()
    flyBtn.BackgroundColor3 = flying and COLOR_ON or COLOR_OFF
end)
flyBtn.MouseButton1Down:Connect(function()
    flyBtn.BackgroundColor3 = COLOR_CLICK
end)
flyBtn.MouseButton1Up:Connect(function()
    flyBtn.BackgroundColor3 = flying and COLOR_ON or COLOR_HOVER
end)

local function setupPhysics(root)
    if root:FindFirstChild("FlyBV") then root.FlyBV:Destroy() end
    if root:FindFirstChild("FlyBG") then root.FlyBG:Destroy() end
    bv = Instance.new("BodyVelocity", root)
    bv.Name = "FlyBV"
    bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bv.Velocity = Vector3.new(0,0,0)
    bg = Instance.new("BodyGyro", root)
    bg.Name = "FlyBG"
    bg.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
    bg.P = 15000
end

local toggleFlyConnection
local function toggleFly()
    flying = not flying
    local char = player.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    if not root or not hum then return end

    if flying then
        setupPhysics(root)
        hum.PlatformStand = true
        flyBtn.BackgroundColor3 = COLOR_ON

        -- 開啟穿牆
        toggleFlyConnection = RunService.Stepped:Connect(function()
            if flying and char then
                for _, part in pairs(char:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end
        end)
    else
        if bv then bv:Destroy() end
        if bg then bg:Destroy() end
        hum.PlatformStand = false
        hum:ChangeState(Enum.HumanoidStateType.GettingUp)
        flyBtn.BackgroundColor3 = COLOR_OFF


        if toggleFlyConnection then
            toggleFlyConnection:Disconnect()
            toggleFlyConnection = nil
        end
    end
end

flyBtn.MouseButton1Click:Connect(toggleFly)

speedBox.FocusLost:Connect(function()
    speed = tonumber(speedBox.Text) or speed
    speedBox.Text = tostring(speed)
end)

UIS.InputBegan:Connect(function(input, g)
    if g then return end
    local k = input.KeyCode.Name
    if keys[k] ~= nil then keys[k] = true end
    if input.KeyCode == Enum.KeyCode.H then toggleFly() end
end)
UIS.InputEnded:Connect(function(input)
    local k = input.KeyCode.Name
    if keys[k] ~= nil then keys[k] = false end
end)

RunService.RenderStepped:Connect(function()
    local char = player.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if flying and root and bv and bg then
        local cam = workspace.CurrentCamera
        local fwd = (keys.W and 1 or 0) - (keys.S and 1 or 0)
        local side = (keys.D and 1 or 0) - (keys.A and 1 or 0)
        local up = (keys.Space and 1 or 0) - (keys.LShift and 1 or 0)
        local dir = cam.CFrame:VectorToWorldSpace(Vector3.new(side, up, -fwd))
        bv.Velocity = dir.Magnitude > 0 and (dir.Unit * speed) or Vector3.new(0,0,0)
        bg.CFrame = cam.CFrame
    end
end)
